# Мини-CRM Распределения Лидов

Сервис на FastAPI для распределения лидов между операторами на основе весов источников и лимитов нагрузки.

## Установка

1.  **Установка зависимостей**:
    ```bash
    pip install -r requirements.txt
    ```

2.  **Запуск приложения**:
    ```bash
    uvicorn main:app --reload
    ```

## Описание Логики

### Сущности
-   **Оператор (Operator)**: Имеет лимит нагрузки и статус активности.
-   **Источник / Бот (Source)**: Источник, откуда пришел лид.
-   **Лид (Lead)**: Идентифицируется уникальной строкой (например, email).
-   **Обращение (Interaction)**: Запись о том, что лид обратился через источник.
-   **Связь Источник-Оператор (SourceOperatorLink)**: Определяет вес оператора для конкретного источника.

### Алгоритм Распределения
1.  **Определение Лида**: Находит существующего лида по идентификатору или создает нового.
2.  **Выбор Оператора**:
    -   Получает операторов, связанных с источником.
    -   Отфильтровывает неактивных операторов.
    -   Отфильтровывает операторов, у которых текущее количество обращений со статусом "OPEN" >= `load_limit`.
    -   Из оставшихся кандидатов выбирает одного, используя **взвешенный случайный выбор** на основе настроенных весов.
    -   Если кандидатов нет, обращение создается с `operator_id=None`.

### Определение Нагрузки
"Нагрузка" определяется как количество обращений, назначенных оператору, которые имеют статус "OPEN".

## Использование API

### 1. Создание Операторов
```http
POST /operators/
{
  "name": "Operator 1",
  "load_limit": 10
}
```

### 2. Создание Источника
```http
POST /sources/
{
  "name": "Bot A"
}
```

### 3. Настройка Весов
```http
POST /sources/{source_id}/allocations
[
  { "operator_id": 1, "weight": 10 },
  { "operator_id": 2, "weight": 30 }
]
```

### 4. Регистрация Обращения
```http
POST /interactions/
{
  "lead_identifier": "user@example.com",
  "source_id": 1,
  "message": "Hello"
}
```

### 5. Просмотр Статистики
```http
GET /stats/
```
